{% extends 'admin/master.html' %}
{% import 'admin/lib.html' as lib with context %}
{% import 'admin/actions.html' as actionlib with context %}
{% import 'admin/model/modals/lib.html' as modal_lib with context %}

{# --------------------------------------------------------- #}
{#  FileAdmin - Directory/File list view (Fomantic-UI theme) #}
{# --------------------------------------------------------- #}

{% block body %}
  {# ------------------------- Toolbar ---------------------- #}
  {% block toolbar %}
    <div class="ui equal width grid stackable basic segment top attached container m-0">
      <div class="column right aligned">
        <div class="ui spaced wrapping icon small buttons listing-menu-bar">
          {% if admin_view.can_upload %}
            {% if admin_view.upload_modal %}
              <a class="ui button modal-opener"
                 href="{{ get_dir_url('.upload', path=dir_path, modal=True) }}"
                 title="{{ _gettext("Upload File") }}">
                <i class="upload icon"></i>
              </a>
            {% else %}
              <a class="ui button"
                 href="{{ get_dir_url('.upload', path=dir_path) }}"
                 title="{{ _gettext("Upload File") }}">
                <i class="upload icon"></i>
              </a>
            {% endif %}
          {% endif %}

          {% if admin_view.can_mkdir %}
            {% if admin_view.mkdir_modal %}
              <a class="ui button modal-opener"
                 href="{{ get_dir_url('.mkdir', path=dir_path, modal=True) }}"
                 title="{{ _gettext("Create Directory") }}">
                <i class="folder plus icon"></i>
              </a>
            {% else %}
              <a class="ui button"
                 href="{{ get_dir_url('.mkdir', path=dir_path) }}"
                 title="{{ _gettext("Create Directory") }}">
                <i class="folder plus icon"></i>
              </a>
            {% endif %}
          {% endif %}

          {% if actions %}
            <div class="ui floating dropdown icon button"
                 title="{{ _gettext("With selected") }}">
              <i class="ellipsis vertical icon"></i>
              <div class="menu">{{ actionlib.dropdown_menu_items(actions) }}</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endblock %}

  {# -------------------- Breadcrumbs ---------------------- #}
  {% block breadcrumbs %}
    <div class="ui small segment top attached breadcrumb">
      <a class="section" href="{{ get_dir_url('.index_view', path=None) }}">{{ _gettext("Root") }}</a>
      {% for name, path in breadcrumbs[:-1] %}
        <i class="right chevron icon divider"></i>
        <a class="section" href="{{ get_dir_url('.index_view', path=path) }}">{{ name }}</a>
      {% endfor %}
      {% if breadcrumbs %}
        <i class="right chevron icon divider"></i>
        <a class="active section"
           href="{{ get_dir_url('.index_view', path=breadcrumbs[-1][1]) }}">{{ breadcrumbs[-1][0] }}</a>
      {% endif %}
    </div>
  {% endblock %}

  {# -------------------- File list table ------------------ #}
  {% block file_list_table %}
    <div class="ui container long scrolling m-0">
      <table class="ui striped very compact small unstackable table model-list">
        <thead>
          <tr>
            {% block list_header scoped %}
              {% if actions %}
                <th>
                  <div class="ui fitted checkbox" title="{{ _gettext("Select all files") }}">
                    <input type="checkbox" name="rowtoggle" class="action-rowtoggle" />
                    <label>&nbsp;</label>
                  </div>
                </th>
              {% endif %}
              {% for column in admin_view.column_list %}
                <th>
                  {% if admin_view.is_column_sortable(column) %}
                    {% if sort_column == column %}
                      <a href="{{ sort_url(column, dir_path, True) }}"
                         title="{{ _gettext('Sort by %(name)s', name=column) }}">
                        {{ admin_view.column_label(column) }}
                        {% if sort_desc %}
                          <i class="chevron up icon"></i>
                        {% else %}
                          <i class="chevron down icon"></i>
                        {% endif %}
                      </a>
                    {% else %}
                      <a href="{{ sort_url(column, dir_path) }}"
                         title="{{ _gettext('Sort by %(name)s', name=column) }}">{{ admin_view.column_label(column) }}</a>
                    {% endif %}
                  {% else %}
                    {{ admin_view.column_label(column) }}
                  {% endif %}
                </th>
              {% endfor %}
              <th></th>
            {% endblock %}
          </tr>
        </thead>
        <tbody>
          {% for name, path, is_dir, size, date in items %}
            <tr>
              {% block list_row scoped %}
                {% if actions %}
                  <td>
                    {% if not is_dir %}
                      <div class="ui fitted checkbox">
                        <input type="checkbox"
                               name="rowid"
                               class="action-checkbox"
                               value="{{ path }}" />
                        <label></label>
                      </div>
                    {% endif %}
                  </td>
                {% endif %}

                {# -------- File/Directory name and attributes --------- #}
                {% if is_dir %}
                  <td colspan="2">
                    <a href="{{ get_dir_url('.index_view', path) |safe }}">
                      <i class="folder outline icon"></i> <span>{{ name }}</span>
                    </a>
                  </td>
                {% else %}
                  <td>
                    {% if admin_view.can_download %}
                      {% if admin_view.edit_modal and admin_view.is_file_editable(path) %}
                        <a class="modal-opener"
                           href="{{ get_file_url(path, modal=True) |safe }}">{{ name }}</a>
                      {% else %}
                        <a href="{{ get_file_url(path) |safe }}">{{ name }}</a>
                      {% endif %}
                    {% else %}
                      {{ name }}
                    {% endif %}
                  </td>
                  {% if admin_view.is_column_visible('size') %}<td>{{ size|filesizeformat }}</td>{% endif %}
                {% endif %}

                {% if admin_view.is_column_visible('date') %}<td>{{ timestamp_format(date) }}</td>{% endif %}

                {# -------- Row action buttons (rename / delete) ------- #}
                <td>
                  <div class="ui icon tiny buttons">
                    {% block list_row_actions scoped %}
                      {% if admin_view.can_rename and path and name != '..' %}
                        {% if admin_view.rename_modal %}
                          <a class="ui button modal-opener"
                             href="{{ get_url('.rename', path=path, modal=True) }}"
                             title="{{ _gettext("Rename File") }}">
                            <i class="pencil alternate icon"></i>
                          </a>
                        {% else %}
                          <a class="ui button"
                             href="{{ get_url('.rename', path=path) }}"
                             title="{{ _gettext("Rename File") }}">
                            <i class="pencil alternate icon"></i>
                          </a>
                        {% endif %}
                      {% endif %}
                      {% if admin_view.can_delete and path %}
                        {% if is_dir %}
                          {% if name != '..' and admin_view.can_delete_dirs %}
                            <form method="post" action="{{ get_url(".delete") }}">
                              {{ delete_form.path(value=path) }}
                              {% if delete_form.csrf_token is defined and delete_form.csrf_token %}{{ delete_form.csrf_token }}{% endif %}
                              <button type="submit"
                                      class="ui red icon button"
                                      onclick="return confirm('{{ _gettext('Are you sure you want to delete \\\'%(name) s\\\' recursively?', name=name) }}')">
                                <i class="trash icon"></i>
                              </button>
                            </form>
                          {% endif %}
                        {% else %}
                          <form method="post" action="{{ get_url(".delete") }}">
                            {{ delete_form.path(value=path) }}
                            {% if delete_form.csrf_token is defined and delete_form.csrf_token %}{{ delete_form.csrf_token }}{% endif %}
                            <button type="submit"
                                    class="ui red icon button"
                                    onclick="return confirm('{{ _gettext('Are you sure you want to delete \\\'%(name) s\\\'?', name=name) }}')"
                                    title="{{ _gettext("Delete File") }}">
                              <i class="trash icon"></i>
                            </button>
                          </form>
                        {% endif %}
                      {% endif %}
                    {% endblock %}
                  </div>
                </td>
              {% endblock %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endblock %}

  {# -------------------- Hidden actions form --------------- #}
  {% block actions %}{{ actionlib.form(actions, get_url('.action_view') ) }}{% endblock %}

  {%- if admin_view.rename_modal or admin_view.mkdir_modal or admin_view.upload_modal or admin_view.edit_modal -%}
    {{ modal_lib.render_form_modal() }}
  {%- endif -%}

{% endblock %}

{# --------------------------- Tail ------------------------ #}
{% block tail_js %}
  {{ super() }}
  {{ lib.form_js() }}

  {%- if admin_view.rename_modal or admin_view.mkdir_modal or admin_view.upload_modal or admin_view.edit_modal -%}
    <script {{ admin_csp_nonce_attribute }}
            src="{{ admin_static.url(filename='fomanticui/js/form_modal.js', v='1.0.0') }}"></script>
  {%- endif -%}

  {{ actionlib.script(_gettext('Please select at least one file.') , actions, actions_confirmation) }}
{% endblock %}
